os.loadAPI("loader")
SpeedOS = loader.OS()

SpeedOS.LoadAPI("SpeedAPI/windows")
SpeedOS.LoadAPI("SpeedAPI/SpeedText")

SpeedOS.ToolBarColour = colours.lightGrey
SpeedOS.ToolBarTextColour = colours.white

fs = SpeedOS.fs

windows.clearScreen(colors.white)

local w, h = term.getSize()

if not http then
  windows.error("You need to have HTTP API to be enabled!")
  SpeedOS.Close()
end


function Menu()
  windows.clearScreen(colors.gray)
  term.setTextColor(colors.white)
  SpeedText.cPrint("Enter program path:", 6)
  selected_path = SpeedText.centerRead(w - 13, "", colors.lightGray, colors.white, colors.white, false)
  if not selected_path then
    SpeedOS.Close()
  end

  GetProgram(selected_path)
end

function GetProgram(selected)
  result = http.get("https://raw.githubusercontent.com/ma3rxofficial/ComputerCraft/main/"..selected)
  
  if not result then
    windows.clearScreen(colors.cyan)
    windows.error("Program not exists!")
    Menu()
  end  

  if not fs.exists(selected) then
    windows.clearScreen(colors.white)
    button = windows.select({"New program!"},{"Do you want to download it?"},{"No",colors.lightGray,colors.black}, {"Yes",colors.lightBlue,colors.black})

    if button == "No" then
      Menu()
    end  

    file_New = fs.open(selected, "w")
    file_New.write(result.readAll())
    file_New.close()

    windows.clearScreen(colors.white)
    term.setTextColor(colors.lightGray)
    SpeedText.cPrint("Downloaded!")
    sleep(0.5)
    SpeedText.cPrint("Click anywhere to continue...", 10)

    Menu()
  end

  result_data = result.readAll()
  selected_file = fs.open(selected, "r")
  selected_file_data = selected_file.readAll()

  if result_data == selected_file_data then
    windows.clearScreen(colors.white)
    term.setTextColor(colors.lightGray)
    SpeedText.cPrint("Program is up to date!")
    sleep(3)
    Menu()
  end

  windows.clearScreen(colors.white)

  button = windows.select({"Program have new version!"},{"Do you want to update it?"},{"No",colors.lightGray,colors.black}, {"Yes",colors.lightBlue,colors.black})

  if button == "No" then
    Menu()
  end  

  selected_file2 = fs.open(selected, "w")

  windows.clearScreen(colors.white)
  term.setTextColor(colors.lightGray)
  SpeedText.cPrint("Updating...")
  selected_file2.write(result_data)
  sleep(1)
  windows.clearScreen(colors.white)
  term.setTextColor(colors.lightGray)
  SpeedText.cPrint("Updated!")
  sleep(0.5)
  SpeedText.cPrint("Click anywhere to continue...", 10)

  os.pullEvent("mouse_click")

  selected_file.close()
  selected_file2.close()

  Menu()
end

Menu()
