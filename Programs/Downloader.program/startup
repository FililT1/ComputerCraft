-----------------------------------------------------------------------------------------------------------------------------------
-- Меняем цвет верхнего тулбара

if SpeedOS then
  SpeedOS.ToolBarColour = colours.lightGrey
  SpeedOS.ToolBarTextColour = colours.white
end

-----------------------------------------------------------------------------------------------------------------------------------
-- Подгружаем АПИ для работы программы

SpeedOS.LoadAPI("SpeedAPI/windows")
SpeedOS.LoadAPI("SpeedAPI/config")

-----------------------------------------------------------------------------------------------------------------------------------
-- Активация глобальной файловой системы

fs = SpeedOS.FS

-----------------------------------------------------------------------------------------------------------------------------------
-- Конфиг, ебтвоюмать

pathToConfig = "System/Downloader.settings" -- путь до файла с параметрами программы(иначе - файл конфигурации)
use_http = SpeedText.stringToBoolean(config.read(pathToConfig, "enable http")) -- параметр поддержки сайтов по протоколу http, заместо стандартного https

-----------------------------------------------------------------------------------------------------------------------------------
-- Функция скачивания файла

function downloadFile(link, path)
  -- Автоматическое добавление названия протокола в начало строки
  if use_http then -- в случае, если включена поддержка протокола HTTP
    if not string.find(link, "http://") then -- в случае, если в строке ссылки на скачиваемый файл нету названия протокола
      link = "http://"..link -- добавляем в начало ссылки протокол http
    end
    
  else -- если поддержка HTTP отключена
    if not string.find(link, "https://") then -- в случае, если в строке ссылки на скачиваемый файл нету названия протокола
      link = "https://"..link -- добавляем в начало ссылки протокол https
    end
  end

  data = http.get(link) -- отправляем запрос на указанную пользователем ссылку для дальнейшего скачивания файла

  if not data then -- если ответа на отправленный запрос от сервера скачивания не последовало
    windows.clearScreen(colors.cyan) -- чистим экран в бирюзовый цвет
    windows.error("Can't connect to URL!") -- выводим ошибку о том, что ответа от сервера нет
    Menu() -- снова запускаем меню
  end

  if not fs.exists(path) then
    fs.makeDir(path)
    fs.delete(path)
  end

  f = fs.open(path, "w")
  f.write(data.readAll())
  f.close()
end

-----------------------------------------------------------------------------------------------------------------------------------
-- Основная менюшка

function Menu()
  windows.clearScreen(colors.cyan)
  local vvedeno = windows.input("auto","auto","Download",20,{"Link",""},{"Save as",""})

  downloadFile(vvedeno[1], vvedeno[2])
  windows.clearScreen(colors.cyan)
  windows.attention({"Sucessfuly downloaded!"}, {"File was saved as", vvedeno[2].."!"})
end

-----------------------------------------------------------------------------------------------------------------------------------
-- Запуск меню

while true do
  Menu()
end

-----------------------------------------------------------------------------------------------------------------------------------